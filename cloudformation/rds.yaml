AWSTemplateFormatVersion: '2010-09-09'
Description: Aurora MySQL RDS Cluster for Ghost Blog

Resources:

  # Aurora Subnet Group (required to deploy across multiple Availability Zones)
  GhostDBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: "Aurora Subnet Group"
      SubnetIds:
        - !ImportValue GhostPrivateSubnet1Id
        - !ImportValue GhostPrivateSubnet2Id

  # Aurora DB Cluster (stores the actual data)
  GhostAuroraCluster:
    Type: AWS::RDS::DBCluster
    Properties:
      Engine: aurora-mysql
      EngineVersion: "8.0.mysql_aurora.3.05.2"
      MasterUsername: !Sub "{{resolve:secretsmanager:GhostDBCredentials:SecretString:username}}"
      MasterUserPassword: !Sub "{{resolve:secretsmanager:GhostDBCredentials:SecretString:password}}"
      DBSubnetGroupName: !Ref GhostDBSubnetGroup
      VpcSecurityGroupIds:
        - !ImportValue GhostDBSecurityGroupId
      BackupRetentionPeriod: 1  # Retain snapshots for 1 day (minimal cost)
      PreferredBackupWindow: "03:00-04:00"
      StorageEncrypted: true
      DeletionProtection: false

  # Aurora DB Instance (smallest and cheapest for MVP)
  GhostAuroraInstance:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Delete
    Properties:
      DBClusterIdentifier: !Ref GhostAuroraCluster
      DBInstanceClass: db.t4g.medium
      Engine: aurora-mysql
      PubliclyAccessible: false

Outputs:

  AuroraEndpoint:
    Description: "Aurora DB endpoint used by ECS app"
    Value: !GetAtt GhostAuroraCluster.Endpoint.Address
    Export:
      Name: GhostAuroraEndpoint
